name: CI

on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Windows MinGW release
    runs-on: windows-2022

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSYS2 / MinGW (install toolchain, cmake, ninja)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja

    - name: Show CMake version
      run: |
        # 确保使用 MSYS2 的 mingw 工具链（msys2 默认安装在 C:\msys64）
        export PATH="/c/msys64/mingw64/bin:$PATH"
        cmake --version

    - name: Configure (use CMake preset)
      run: |
        export PATH="/c/msys64/mingw64/bin:$PATH"
        cmake --preset release

    - name: Build (use CMake build preset)
      run: |
        export PATH="/c/msys64/mingw64/bin:$PATH"
        cmake --build --preset release

    - name: List build outputs
      run: |
        echo "PWD: $(pwd)"
        echo "Listing likely output directories..."
        ls -la build || true
        ls -la build/release || true
        ls -la build/release/bin || true
        echo "Find executables:"
        find build -type f -name '*.exe' -print || true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mine_clearance-windows-build
        path: |
          build/release/bin/**
          build/**/bin/**
          fonts/**
